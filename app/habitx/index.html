<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HabitX - Rastreador de H√°bitos</title>
    <meta name="theme-color" content="#100b1a"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #120c1f;
            --primary-color: #8b5cf6;
            --primary-color-light: #a78bfa;
            --primary-color-dark: #7c3aed;
            --primary-color-hover-bg: rgba(139, 92, 246, 0.15); /* For hover on transparent items */
            --green-color: #4ade80;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-x pan-y;
            background-color: var(--bg-color);
            color: #e2e8f0;
            transition: background-color 0.4s ease;
        }
        #app.modal-open {
            transform: scale(0.98);
            filter: blur(4px);
            opacity: 0.7;
        }
        #app {
            transition: transform 0.3s ease, filter 0.3s ease, opacity 0.3s ease;
        }
        .glass-effect {
            background: rgba(28, 19, 48, 0.5);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.8s cubic-bezier(0.65, 0, 0.35, 1), stroke 0.3s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .modal-container { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease; }
        .modal-container.hidden { pointer-events: none; opacity: 0; }
        .modal-container.hidden .modal-content { transform: translateY(50px) scale(0.95); opacity: 0; }
        .date-strip-item { transition: all 0.2s ease-in-out; }
        .habit-item { transition: transform 0.2s ease, background-color 0.2s ease; }
        .habit-item:hover { transform: translateY(-2px); background-color: var(--primary-color-hover-bg); }

        /* --- THEME COLOR CLASSES --- */
        .text-primary { color: var(--primary-color); }
        .text-primary-light { color: var(--primary-color-light); }
        .bg-primary { background-color: var(--primary-color); }
        .bg-primary:hover { background-color: var(--primary-color-dark); }
        .border-primary { border-color: var(--primary-color); }
        .focus-border-primary:focus { border-color: var(--primary-color-light); }
        .ring-primary, .focus-ring-primary:focus { --tw-ring-color: var(--primary-color) }
        .placeholder-primary::placeholder { color: var(--primary-color-light); opacity: 0.8; }
        .active-btn { background-color: var(--primary-color) !important; color: white; }
        .freq-btn.active, .weekday-btn.active, .habit-type-btn.active { box-shadow: 0 0 10px var(--primary-color); }
        .date-strip-item.active { background-color: var(--primary-color); color: white; transform: scale(1.1); }
        .habit-progress-circle-fg { stroke: var(--primary-color-light); transition: stroke-dashoffset 0.8s cubic-bezier(0.65, 0, 0.35, 1), stroke 0.3s ease; }
        .habit-progress-circle-fg.completed { stroke: var(--green-color); }
        .progress-ring-circle.main { stroke: var(--primary-color-light); }
        .detail-progress-circle.completed { stroke: var(--green-color); }
        .detail-progress-circle.in-progress { stroke: var(--primary-color); }
        /* --- END THEME COLOR CLASSES --- */

        .habit-progress-circle-bg { stroke: rgba(255, 255, 255, 0.1); }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.8) sepia(1) saturate(5) hue-rotate(220deg); cursor: pointer; } /* Themed picker */
        input:required:invalid, input:invalid { border-bottom-color: #f87171; }
        .calendar-day.completed { background-color: var(--green-color); color: #1a202c; border-radius: 50%; font-weight: bold; }
        .calendar-day-header { font-size: 0.75rem; color: #94a3b8; font-weight: bold; }
        .control-btn { transition: all 0.2s ease; }
        .icon-btn:hover { transform: scale(1.2); }
        #startPauseTimerBtn:disabled { background-color: var(--green-color) !important; color: white !important; cursor: not-allowed; opacity: 0.8; }
        
        .color-swatch { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 2px solid transparent; }
        .color-swatch.active { transform: scale(1.15); box-shadow: 0 0 0 3px var(--bg-color), 0 0 0 5px var(--primary-color); }
        #colorPickerInput { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 40px; height: 40px; background-color: transparent; border: none; cursor: pointer; }
        #colorPickerInput::-webkit-color-swatch { border-radius: 50%; border: 2px solid #94a3b8; }
        #colorPickerInput::-moz-color-swatch { border-radius: 50%; border: 2px solid #94a3b8; }
        
        /* -- STYLES NOTES SECTION -- */
        .notes-content { min-height: 80px; background: rgba(40, 30, 60, 0.5); padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); }
        .notes-content > *:first-child { margin-top: 0; }
        .notes-content > *:last-child { margin-bottom: 0; }
        .notes-content h1, .notes-content h2, .notes-content h3, .notes-content h4 { margin: 0.8em 0 0.4em 0; font-weight: 600; line-height: 1.2; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 0.2em; }
        .notes-content h1 { font-size: 1.5em; }
        .notes-content h2 { font-size: 1.3em; }
        .notes-content h3 { font-size: 1.15em; }
        .notes-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .notes-content ul, .notes-content ol { margin-bottom: 0.75rem; padding-left: 1.75rem; }
        .notes-content li { margin-bottom: 0.25rem; }
        .notes-content blockquote { border-left: 4px solid var(--primary-color); padding-left: 1rem; margin: 0 0 0.75rem 0; color: var(--primary-color-light); font-style: italic; }
        .notes-content pre { background-color: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem; }
        .notes-content code { font-family: monospace; background-color: rgba(0,0,0,0.2); padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
        .notes-content pre code { background-color: transparent; padding: 0; }
        .note-scope-btn { padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid transparent; transition: all 0.2s ease; }
        .note-scope-btn.active { background-color: var(--primary-color); border-color: var(--primary-color-light); color: white; }
        .note-scope-btn:not(.active) { background-color: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="text-white overflow-hidden h-screen">

<div id="app" class="min-h-screen flex flex-col items-center pt-8 pb-24 overflow-y-auto h-full">
    <header class="w-full max-w-md px-4 flex justify-between items-center mb-6">
        <h1 id="settingsBtn" class="text-3xl font-bold tracking-wider cursor-pointer transition-transform hover:scale-105">Habit<span id="brandX" class="text-primary transition-colors duration-300">X</span></h1>
        <div class="flex items-center gap-3">
            <button id="returnToTodayBtn" aria-label="Voltar para hoje" class="bg-slate-700 hover:bg-slate-600 text-white font-bold w-11 h-11 rounded-full text-lg flex items-center justify-center shadow-lg transition-all transform hover:scale-110 active:scale-100 hidden">
                <i class="fa-solid fa-arrow-rotate-left"></i>
            </button>
            <button id="addHabitBtn" aria-label="Adicionar novo h√°bito" class="bg-primary text-white font-bold w-11 h-11 rounded-full text-xl flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 active:scale-100">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </header>

    <main id="mainView" class="w-full max-w-md flex-grow">
        <div id="date-strip-container" class="mb-6 px-4">
            <div class="flex justify-between items-center text-center"></div>
        </div>

        <div id="content-container" class="transition-transform duration-300 ease-out">
            <div class="px-4">
                <div class="flex flex-col items-center mb-8">
                    <div class="relative w-48 h-48">
                        <svg class="w-full h-full" viewBox="0 0 120 120">
                            <circle class="stroke-current text-gray-700/50" cx="60" cy="60" r="54" fill="none" stroke-width="12"></circle>
                            <circle id="overallProgressCircle" class="progress-ring-circle main" cx="60" cy="60" r="54" fill="none" stroke-width="12" stroke-linecap="round" style="stroke-dasharray: 339.292; stroke-dashoffset: 339.292;"></circle>
                        </svg>
                        <div id="overallProgressText" class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="dayLabel" class="text-xl font-bold">Hoje</span>
                            <span id="overallPercentage" class="text-4xl font-bold">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="habitListContainer"></div>
        </div>
    </main>
</div>

<!-- Edit/Add Habit Modal -->
<div id="habitModal" class="modal-container fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center p-4 z-50 hidden">
    <div id="habitModalContent" class="modal-content glass-effect w-full max-w-md p-6 rounded-t-3xl shadow-2xl max-h-[90vh] overflow-y-auto">
        <form id="habitForm">
            <input type="hidden" id="habitId">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-center">Novo H√°bito</h2>
            <div class="flex items-center gap-4 mb-6">
                <button type="button" id="openIconModalBtn" aria-label="Escolher √≠cone" class="text-4xl p-3 bg-slate-700/50 rounded-2xl control-btn hover:scale-110 active:scale-100">üéØ</button>
                <input type="hidden" id="habitIcon" value="üéØ">
                <input id="habitName" type="text" placeholder="Nome do H√°bito" class="w-full bg-transparent border-b-2 border-primary p-2 text-white text-lg placeholder-primary focus:outline-none focus-border-primary transition" required>
            </div>

            <div class="space-y-6">
                <div>
                    <p class="mb-2 text-primary-light font-semibold">Repeti√ß√£o</p>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="hidden" id="habitFrequency" value="daily">
                        <button type="button" data-freq="none" class="freq-btn control-btn flex-1 bg-slate-800 p-3 rounded-lg text-sm">√önico Dia</button>
                        <button type="button" data-freq="daily" class="freq-btn control-btn flex-1 bg-slate-800 p-3 rounded-lg text-sm">Di√°rio</button>
                        <button type="button" data-freq="custom" class="freq-btn control-btn flex-1 bg-slate-800 p-3 rounded-lg text-sm">Semanal</button>
                    </div>
                    <div id="customWeekdays" class="hidden mt-3 flex justify-around bg-slate-800/50 p-2 rounded-lg"></div>
                </div>
                 <div>
                    <p class="mb-2 text-primary-light font-semibold">Tipo de Meta</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" data-type="yes_no" class="habit-type-btn control-btn flex-1 bg-slate-800 p-3 rounded-lg text-sm"><i class="fas fa-check-circle mr-1"></i>Sim/N√£o</button>
                        <button type="button" data-type="measurable" class="habit-type-btn control-btn flex-1 bg-slate-800 p-3 rounded-lg text-sm"><i class="fas fa-ruler-combined mr-1"></i>Medida</button>
                        <button type="button" data-type="timed" class="habit-type-btn control-btn flex-1 bg-slate-800 p-3 rounded-lg text-sm"><i class="fas fa-clock mr-1"></i>Tempo</button>
                    </div>
                    <input type="hidden" id="habitType" value="yes_no">
                </div>

                <div id="goalOptionsContainer" class="hidden">
                    <div id="measurableOptions" class="hidden">
                        <p class="mb-2 text-primary-light font-semibold">Definir Medida</p>
                        <div class="flex items-center space-x-4">
                            <input id="habitGoal" type="number" placeholder="Meta" class="w-1/2 bg-transparent border-b-2 border-primary p-2 text-white placeholder-primary focus:outline-none">
                            <input id="habitUnit" type="text" placeholder="Unidade (ex: copos)" class="w-1/2 bg-transparent border-b-2 border-primary p-2 text-white placeholder-primary focus:outline-none">
                        </div>
                    </div>
                    <div id="timedOptions" class="hidden">
                         <p class="mb-2 text-primary-light font-semibold">Definir Tempo</p>
                        <div class="flex items-center space-x-4">
                             <input id="habitTimeGoal" type="number" placeholder="Meta" class="w-1/2 bg-transparent border-b-2 border-primary p-2 text-white placeholder-primary focus:outline-none">
                            <select id="habitTimeUnit" class="w-1/2 bg-primary/70 border-none p-2 rounded-lg text-white focus:outline-none">
                                <option value="minutes">Minutos</option>
                                <option value="hours">Horas</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="eventScheduleContainer">
                    <p class="mb-2 text-primary-light font-semibold">Hor√°rio <span id="scheduleOptionalText" class="font-light text-sm">(Opcional)</span></p>
                    <div class="grid grid-cols-3 gap-4">
                        <div id="eventDateFieldWrapper" class="col-span-1">
                            <label for="eventDate" class="text-xs text-primary-light flex items-center">Data <span id="dateRequiredIndicator" class="text-red-400 ml-1 hidden">*</span></label>
                            <input type="date" id="eventDate" class="w-full bg-transparent border-b-2 border-primary p-2 text-white focus:outline-none transition-colors">
                        </div>
                        <div class="col-span-1">
                             <label for="startTime" class="text-xs text-primary-light">In√≠cio</label>
                             <input type="time" id="startTime" class="w-full bg-transparent border-b-2 border-primary p-2 text-white focus:outline-none">
                        </div>
                        <div class="col-span-1">
                             <label for="endTime" class="text-xs text-primary-light">Fim</label>
                             <input type="time" id="endTime" class="w-full bg-transparent border-b-2 border-primary p-2 text-white focus:outline-none">
                        </div>
                    </div>
                </div>
                <div>
                     <p class="mb-2 text-primary-light font-semibold">Nota Geral do H√°bito <span class="font-light text-sm">(Opcional)</span></p>
                     <textarea id="habitGeneralNote" placeholder="Esta nota aparecer√° em todos os dias do h√°bito..." rows="3" class="w-full bg-slate-800/60 p-3 rounded-lg text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus-ring-primary"></textarea>
                </div>
            </div>

            <div class="flex space-x-4 mt-8">
                <button type="button" id="cancelBtn" class="flex-1 bg-slate-600 hover:bg-slate-700 font-bold py-3 rounded-xl control-btn active:scale-95">Cancelar</button>
                <button type="submit" class="flex-1 bg-primary font-bold py-3 rounded-xl control-btn active:scale-95">Salvar</button>
            </div>
             <button type="button" id="deleteBtn" class="w-full mt-4 bg-red-600 hover:bg-red-700 font-bold py-3 rounded-xl control-btn active:scale-95 hidden">Excluir H√°bito</button>
        </form>
    </div>
</div>

<!-- Icon Picker Modal -->
<div id="iconModal" class="modal-container fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[60] hidden">
    <div class="modal-content glass-effect w-full max-w-md p-6 rounded-2xl shadow-2xl">
        <h2 class="text-xl font-bold mb-2 text-center">Escolha um √çcone</h2>
        <p class="text-center text-slate-400 mb-4 text-sm">Cole seu emoji abaixo ou escolha uma sugest√£o.</p>
        <input type="text" id="emojiInput" maxlength="2" placeholder="‚ú®" class="w-full text-center text-4xl bg-slate-900/70 p-2 rounded-lg mb-4 focus:outline-none focus:ring-2 focus-ring-primary">
        <div id="iconGrid" class="grid grid-cols-6 gap-4 max-h-48 overflow-y-auto border-t border-slate-700 pt-4"></div>
        <button id="confirmIconBtn" class="w-full mt-4 bg-primary font-bold py-2 rounded-xl control-btn active:scale-95">Confirmar</button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-container fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center p-4 z-50 hidden">
    <div id="settingsModalContent" class="modal-content glass-effect w-full max-w-md p-6 rounded-t-3xl shadow-2xl max-h-[90vh] overflow-y-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Configura√ß√µes</h2>
        
        <div id="overallStatsContainer" class="mb-8"></div>

        <div class="mb-6">
            <p class="mb-3 text-primary-light font-semibold">Cor do Tema</p>
            <div id="colorSwatches" class="flex justify-center gap-4 flex-wrap items-center"></div>
            <button id="resetColorBtn" class="w-full mt-4 bg-slate-600 hover:bg-slate-700 font-bold py-2 rounded-xl control-btn active:scale-95 text-sm">Restaurar Cor Padr√£o</button>
        </div>

        <div class="mb-6">
            <p class="mb-3 text-primary-light font-semibold">Gerenciamento de Dados</p>
            <div class="space-y-3">
                <button id="exportDataBtn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 rounded-xl control-btn active:scale-95">Exportar Dados (.json)</button>
                <button id="importDataBtn" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 rounded-xl control-btn active:scale-95">Importar Dados (.json)</button>
                <input type="file" id="importFileInput" class="hidden" accept=".txt,.json,application/json">
            </div>
        </div>

        <button type="button" id="closeSettingsBtn" class="w-full mt-6 bg-slate-800 hover:bg-slate-700 font-bold py-3 rounded-xl control-btn active:scale-95">Fechar</button>
    </div>
</div>

<!-- Habit Detail View -->
<div id="habitDetailView" class="fixed inset-0 bg-var(--bg-color) z-[60] transition-transform duration-500 ease-in-out p-4 pt-8 flex flex-col" style="transform: translateX(100%);">
    <header class="flex items-center mb-6 px-2">
        <button id="closeDetailViewBtn" aria-label="Voltar" class="text-2xl p-2 mr-2 text-slate-300 hover:text-white control-btn"><i class="fas fa-arrow-left"></i></button>
        <div id="detailIcon" class="text-3xl mr-4"></div>
        <h2 id="detailHabitName" class="text-2xl font-bold flex-1 truncate"></h2>
        <button id="editHabitFromDetailBtn" aria-label="Editar h√°bito" class="text-xl p-2 text-slate-300 hover:text-white control-btn"><i class="fas fa-ellipsis-v"></i></button>
    </header>
    <div class="flex-grow overflow-y-auto pb-8">
        <div id="detailLogTodayContainer" class="glass-effect p-6 rounded-2xl mb-6 mx-2"></div>
        <div id="notesSectionContainer" class="glass-effect p-6 rounded-2xl mx-2 mt-6 mb-8"></div>
        <div id="calendarContainer" class="glass-effect p-6 rounded-2xl mb-6 mx-2"></div>
        <div id="statsContainer" class="glass-effect p-6 rounded-2xl mx-2"></div>
    </div>
</div>

<!-- Service Worker Script -->
<script id="sw-script" type="text/service-worker">
    const CACHE_NAME = 'habitx-cache-v4';
    const URLS_TO_CACHE = [
      './', 
      'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css',
      'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
      'https://cdn.tailwindcss.com',
      'https://cdn.jsdelivr.net/npm/marked/marked.min.js'
    ];
    self.addEventListener('install', event => {
      event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(URLS_TO_CACHE)));
    });
    self.addEventListener('fetch', event => {
      if (event.request.method !== 'GET') return;
      event.respondWith(
        caches.match(event.request).then(cachedResponse => {
            const fetchPromise = fetch(event.request).then(networkResponse => {
                caches.open(CACHE_NAME).then(cache => {
                    cache.put(event.request, networkResponse.clone());
                });
                return networkResponse;
            });
            return cachedResponse || fetchPromise;
        })
      );
    });
    self.addEventListener('activate', event => {
      const cacheWhitelist = [CACHE_NAME];
      event.waitUntil(caches.keys().then(cacheNames => Promise.all(
          cacheNames.map(cacheName => {
              if (!cacheWhitelist.includes(cacheName)) return caches.delete(cacheName);
          })
      )));
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Service Worker ---
    if ('serviceWorker' in navigator) {
        try {
            const swBlob = new Blob([document.getElementById('sw-script').textContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl, { scope: './' })
                .then(reg => console.log('Service Worker: Registrado com sucesso', reg.scope))
                .catch(err => console.error('Service Worker: Falha no Registro', err));
        } catch (e) { console.error('Service Worker: Erro ao criar blob', e); }
    }

    // --- Elements ---
    const appContainer = document.getElementById('app');
    const contentContainer = document.getElementById('content-container');
    const dateStripContainer = document.getElementById('date-strip-container').firstElementChild;
    const overallProgressCircle = document.getElementById('overallProgressCircle');
    const overallPercentage = document.getElementById('overallPercentage');
    const dayLabel = document.getElementById('dayLabel');
    const habitListContainer = document.getElementById('habitListContainer');
    const addHabitBtn = document.getElementById('addHabitBtn');
    const returnToTodayBtn = document.getElementById('returnToTodayBtn');
    const habitModal = document.getElementById('habitModal');
    const habitForm = document.getElementById('habitForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const habitTypeButtons = document.querySelectorAll('.habit-type-btn');
    const goalOptionsContainer = document.getElementById('goalOptionsContainer');
    const measurableOptions = document.getElementById('measurableOptions');
    const timedOptions = document.getElementById('timedOptions');
    const openIconModalBtn = document.getElementById('openIconModalBtn');
    const habitIconInput = document.getElementById('habitIcon');
    const freqButtons = document.querySelectorAll('.freq-btn');
    const customWeekdaysContainer = document.getElementById('customWeekdays');
    const eventDateInput = document.getElementById('eventDate');
    const dateRequiredIndicator = document.getElementById('dateRequiredIndicator');
    const scheduleOptionalText = document.getElementById('scheduleOptionalText');
    const eventDateFieldWrapper = document.getElementById('eventDateFieldWrapper');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    const iconModal = document.getElementById('iconModal');
    const iconGrid = document.getElementById('iconGrid');
    const confirmIconBtn = document.getElementById('confirmIconBtn');
    const emojiInput = document.getElementById('emojiInput');
    const habitDetailView = document.getElementById('habitDetailView');
    const closeDetailViewBtn = document.getElementById('closeDetailViewBtn');
    const editHabitFromDetailBtn = document.getElementById('editHabitFromDetailBtn');
    const detailIcon = document.getElementById('detailIcon');
    const detailHabitName = document.getElementById('detailHabitName');
    const detailLogTodayContainer = document.getElementById('detailLogTodayContainer');
    const calendarContainer = document.getElementById('calendarContainer');
    const statsContainer = document.getElementById('statsContainer');
    const notesSectionContainer = document.getElementById('notesSectionContainer');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const colorSwatchesContainer = document.getElementById('colorSwatches');
    const resetColorBtn = document.getElementById('resetColorBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const importFileInput = document.getElementById('importFileInput');
    const overallStatsContainer = document.getElementById('overallStatsContainer');
    
    // --- State ---
    let habits = JSON.parse(localStorage.getItem('habitsV8')) || [];
    let selectedDate = new Date();
    let currentEditId = null;
    let activeDetailHabit = null; // Stores the raw habit object {id, history, versions}
    let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0;
    let timerInterval = null, sessionStartTime = 0, realTimeUpdateInterval = null;
    let isTimerRunning = false;
    let currentNoteScope = 'day'; // 'day' or 'general'
    
    // --- Constants ---
    const ICONS = ['üéØ', 'üìö', 'üíß', 'üßò', 'üèÉ', 'üèãÔ∏è', 'ü•¶', 'üò¥', '‚úçÔ∏è', 'üìÖ', 'üé®', 'üéµ', 'üßπ', 'üí∞', 'üßë‚Äçüíª', 'üéÆ', '‚ù§Ô∏è', 'üó£Ô∏è', 'üö∂', 'üå±', '‚òÄÔ∏è', '‚≠ê', 'üí°', 'üîë'];
    const WEEKDAYS_SHORT = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
    const THEME_COLORS = { default: '#8b5cf6', blue: '#3b82f6', green: '#22c55e', red: '#ef4444', orange: '#f97316', pink: '#ec4899' };
    const DB_KEY = 'habitsV8';

    // --- Utils ---
    const toISODateString = date => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split("T")[0];
    const formatTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    const hexToRgb = hex => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    };
    const hexToHsl = (H) => {
        let r = 0, g = 0, b = 0;
        if (H.length == 4) { r = "0x" + H[1] + H[1]; g = "0x" + H[2] + H[2]; b = "0x" + H[3] + H[3]; } 
        else if (H.length == 7) { r = "0x" + H[1] + H[2]; g = "0x" + H[3] + H[4]; b = "0x" + H[5] + H[6]; }
        r /= 255; g /= 255; b /= 255;
        let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
        if (delta == 0) h = 0;
        else if (cmax == r) h = ((g - b) / delta) % 6;
        else if (cmax == g) h = (b - r) / delta + 2;
        else h = (r - g) / delta + 4;
        h = Math.round(h * 60);
        if (h < 0) h += 360;
        l = (cmax + cmin) / 2;
        s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
        s = +(s * 100).toFixed(1);
        l = +(l * 100).toFixed(1);
        return {h, s, l};
    };

    // --- Habit Versioning Logic ---
    const getHabitVersionForDate = (habit, date) => {
        if (!habit || !habit.versions || habit.versions.length === 0) return {};
        const dateStr = toISODateString(date);
        const applicableVersions = habit.versions
            .filter(v => v.effectiveDate <= dateStr)
            .sort((a, b) => b.effectiveDate.localeCompare(a.effectiveDate));
        return applicableVersions[0] || habit.versions[0];
    };
    
    // --- Date & Swipe Logic ---
    const changeDate = (days) => {
        selectedDate.setDate(selectedDate.getDate() + days);
        const direction = days > 0 ? 'right' : 'left';
        contentContainer.style.transform = `translateX(${direction === 'left' ? '100%' : '-100%'})`;
        contentContainer.style.opacity = '0';
        setTimeout(() => {
            renderViewForDate(selectedDate);
            contentContainer.style.transition = 'none';
            contentContainer.style.transform = `translateX(${direction === 'left' ? '-100%' : '100%'})`;
            setTimeout(() => {
                contentContainer.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-out';
                contentContainer.style.transform = 'translateX(0)';
                contentContainer.style.opacity = '1';
            }, 20);
        }, 300);
    };
    const handleSwipe = () => {
        if (habitDetailView.style.transform === 'translateX(0px)') return;
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX < 0) changeDate(1); else changeDate(-1);
        }
    };
    appContainer.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });
    appContainer.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    });

    // --- Render Functions ---
    const renderViewForDate = (date) => {
        const isToday = toISODateString(date) === toISODateString(new Date());
        returnToTodayBtn.classList.toggle('hidden', isToday);
        renderDateStrip(date);
        renderHabits(date);
    };

    const renderDateStrip = (centerDate) => {
        dateStripContainer.innerHTML = '';
        for (let i = -3; i <= 3; i++) {
            const date = new Date(centerDate);
            date.setDate(date.getDate() + i);
            const day = date.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0, 3);
            const dateNum = date.getDate();
            const item = document.createElement('div');
            item.className = 'date-strip-item flex flex-col items-center p-2 rounded-lg w-12 cursor-pointer';
            if (i === 0) item.classList.add('active');
            item.innerHTML = `<span class="text-sm font-semibold">${day}</span><span class="text-lg font-bold">${dateNum}</span>`;
            item.onclick = () => { if (i !== 0) changeDate(i); };
            dateStripContainer.appendChild(item);
        }
    };

    const isHabitActiveOnDate = (habit, date) => {
        const version = getHabitVersionForDate(habit, date);
        if (!version.frequency) return false;

        const dateStr = toISODateString(date);
        if (version.frequency === 'none') return version.date === dateStr;
        
        const habitStartDate = habit.versions[0]?.effectiveDate;
        if (habitStartDate && dateStr < habitStartDate) return false;

        return version.frequency === 'daily' || (version.frequency === 'custom' && version.weekdays.includes(date.getDay()));
    };

    const renderHabits = (date) => {
        const dateStr = toISODateString(date);
        const allActiveHabitsForDay = habits.filter(h => isHabitActiveOnDate(h, date));
        
        if (allActiveHabitsForDay.length === 0) {
            habitListContainer.innerHTML = `<div class="text-center text-primary-light py-10 glass-effect rounded-2xl mx-4"><p class="text-lg">Sem h√°bitos para hoje.</p><p class="text-sm mt-2">Adicione um novo no bot√£o '+' acima!</p></div>`;
            updateOverallProgress(allActiveHabitsForDay, date);
            return;
        }

        const sections = { happening: [], scheduled: [], daily: [], completed: [] };
        const isToday = toISODateString(date) === toISODateString(new Date());
        const now = new Date();

        allActiveHabitsForDay.forEach(habit => {
            const version = getHabitVersionForDate(habit, date);
            if (getHabitProgress(habit, dateStr).completed) {
                sections.completed.push(habit);
                return;
            }
            if (isToday && version.startTime) {
                const start = new Date(`${dateStr}T${version.startTime}`);
                const end = version.endTime ? new Date(`${dateStr}T${version.endTime}`) : null;
                if (end && end <= start) end.setDate(end.getDate() + 1);

                if (now >= start && (!end || now <= end)) { sections.happening.push(habit); return; }
            }
            if (version.startTime) sections.scheduled.push(habit);
            else sections.daily.push(habit);
        });
        
        const sortFn = (a, b) => {
            const versionA = getHabitVersionForDate(a, date);
            const versionB = getHabitVersionForDate(b, date);
            return versionA.startTime.localeCompare(versionB.startTime);
        };
        sections.scheduled.sort(sortFn);
        
        habitListContainer.innerHTML = [
            createHabitSection('Acontecendo Agora', sections.happening, dateStr),
            createHabitSection('Pr√≥ximos Eventos', sections.scheduled, dateStr),
            createHabitSection('H√°bitos Di√°rios', sections.daily, dateStr),
            createHabitSection('Conclu√≠dos', sections.completed, dateStr)
        ].join('');

        document.querySelectorAll('.habit-item').forEach(el => {
            const habit = habits.find(h => h.id == el.dataset.id);
            if (habit) el.addEventListener('click', () => openDetailView(habit));
        });
        updateOverallProgress(allActiveHabitsForDay, date);
    };

    const createHabitSection = (title, habitArray, dateStr) => {
        if (habitArray.length === 0) return '';
        const habitHTML = habitArray.map(habit => createHabitItemHTML(habit, dateStr)).join('');
        return `<div class="px-4 mb-6"><h3 class="text-lg font-semibold text-primary-light mb-3">${title}</h3><div class="space-y-3">${habitHTML}</div></div>`;
    };
    
    const createHabitItemHTML = (habit, dateStr) => {
        const date = new Date(dateStr + 'T12:00:00');
        const version = getHabitVersionForDate(habit, date);
        const progress = getHabitProgress(habit, dateStr);
        const isCompleted = progress.percentage >= 100;
        const r = 20, c = 2 * Math.PI * r;
        const offset = c - (progress.percentage / 100) * c;
        const timeInfo = version.startTime ? `<span class="ml-2 text-xs bg-primary/20 px-2 py-1 rounded-md">${version.endTime ? `${version.startTime} - ${version.endTime}` : version.startTime}</span>` : '';
        
        let circleContent = '';
        if (isCompleted) {
            circleContent = '<i class="fas fa-check"></i>';
        } else if (version.type === 'measurable' && progress.value > 0) {
            circleContent = `<span class="text-sm font-bold">${progress.value}</span>`;
        } else if (progress.percentage > 0 && version.type !== 'yes_no') {
            circleContent = `<span class="text-xs font-bold">${Math.round(progress.percentage)}</span>`;
        }

        return `
            <div class="habit-item glass-effect p-4 rounded-2xl flex items-center justify-between cursor-pointer" data-id="${habit.id}">
                <div class="flex items-center flex-1 min-w-0">
                    <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-xl mr-4">${version.icon || 'üéØ'}</div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-white truncate">${version.name}</p>
                        <p class="text-sm text-primary-light flex items-center">${progress.text} ${timeInfo}</p>
                    </div>
                </div>
                <div class="w-12 h-12 relative flex-shrink-0 flex items-center justify-center ml-2">
                    <svg class="w-full h-full" viewBox="0 0 44 44">
                        <circle class="habit-progress-circle-bg" cx="22" cy="22" r="${r}" fill="none" stroke-width="4"></circle>
                        <circle class="habit-progress-circle-fg ${isCompleted ? 'completed' : ''}" cx="22" cy="22" r="${r}" fill="none" stroke-width="4" stroke-linecap="round" style="stroke-dasharray: ${c}; stroke-dashoffset: ${c};" data-offset="${offset}" transform="rotate(-90 22 22)"></circle>
                    </svg>
                    <div class="absolute text-white text-lg flex items-center justify-center w-full h-full">${circleContent}</div>
                </div>
            </div>`;
    };
    
    const triggerCircleAnimations = (container) => {
         setTimeout(() => {
            container.querySelectorAll('.habit-progress-circle-fg').forEach(circle => {
                circle.style.strokeDashoffset = circle.dataset.offset;
            });
        }, 50);
    }

    const getHabitProgress = (habit, dateStr) => {
        const date = new Date(dateStr + 'T12:00:00');
        const version = getHabitVersionForDate(habit, date);
        const entry = habit.history?.[dateStr] || { value: 0, completed: false, note: '' };
        let p = 0, text = 'Pendente';
        
        switch (version.type) {
            case 'yes_no': p = entry.completed ? 100 : 0; text = entry.completed ? 'Conclu√≠do!' : 'Pendente'; break;
            case 'measurable': const goal = version.goal || 1; p = Math.min((entry.value / goal) * 100, 100); text = `${entry.value} / ${goal} ${version.unit || ''}`; if (p >= 100) text = `üéâ Conclu√≠do!`; break;
            case 'timed': const timeGoal = version.timeUnit === 'hours' ? version.timeGoal * 60 : version.timeGoal; p = timeGoal > 0 ? Math.min((entry.value / timeGoal) * 100, 100) : 0; text = `${Math.floor(entry.value||0)} / ${timeGoal} min`; if (p >= 100) text = `üéâ Conclu√≠do!`; break;
        }
        return { percentage: p, value: parseFloat(entry.value) || 0, text, completed: entry.completed || p >= 100, note: entry.note };
    };

    const updateOverallProgress = (habitsForDay, date) => {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) dayLabel.textContent = 'Hoje'; 
        else if (date.toDateString() === yesterday.toDateString()) dayLabel.textContent = 'Ontem'; 
        else dayLabel.textContent = date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
        
        const avgProgress = habitsForDay.length === 0 ? 0 : habitsForDay.reduce((sum, h) => sum + getHabitProgress(h, toISODateString(date)).percentage, 0) / habitsForDay.length;
        setOverallProgress(avgProgress);
        triggerCircleAnimations(habitListContainer);
    };

    function setOverallProgress(percent) {
        const r = overallProgressCircle.r.baseVal.value;
        const c = r * 2 * Math.PI;
        const p = Math.max(0, Math.min(100, percent));
        const offset = c - (p / 100) * c;
        setTimeout(() => { 
             overallProgressCircle.style.strokeDashoffset = offset;
             overallPercentage.textContent = `${Math.round(p)}%`;
        }, 50);
    }

    // --- Modal & View Logic ---
    const openModal = (modal) => { modal.classList.remove('hidden'); appContainer.classList.add('modal-open'); };
    const closeModal = (modal) => {
        modal.classList.add('hidden');
        if (!document.querySelector('.modal-container:not(.hidden)')) appContainer.classList.remove('modal-open');
    };
    
    const openEditModal = (habit = null) => {
        habitForm.reset();
        endTimeInput.setCustomValidity('');
        currentEditId = habit?.id || null;
        
        const version = habit ? getHabitVersionForDate(habit, selectedDate) : {};
        
        modalTitle.textContent = habit ? 'Editar H√°bito' : 'Novo H√°bito';
        deleteBtn.classList.toggle('hidden', !habit);
        
        const data = { 
            icon: 'üéØ', name: '', frequency: 'daily', weekdays: [], type: 'yes_no', 
            goal: 1, unit: '', timeGoal: 60, timeUnit: 'minutes', 
            date: toISODateString(selectedDate), startTime: '', endTime: '', generalNote: '',
            ...version
        };
        
        document.getElementById('habitName').value = data.name;
        document.getElementById('habitIcon').value = data.icon;
        document.getElementById('habitGoal').value = data.goal;
        document.getElementById('habitUnit').value = data.unit;
        document.getElementById('habitTimeGoal').value = data.timeGoal;
        document.getElementById('habitTimeUnit').value = data.timeUnit;
        document.getElementById('eventDate').value = data.date;
        document.getElementById('startTime').value = data.startTime;
        document.getElementById('endTime').value = data.endTime;
        document.getElementById('habitGeneralNote').value = data.generalNote;

        openIconModalBtn.textContent = data.icon;
        selectHabitType(data.type);
        selectFrequency(data.frequency, data.weekdays);
        openModal(habitModal);
    };
    
    const populateIconGrid = () => {
        iconGrid.innerHTML = ICONS.map(icon => `<button type="button" aria-label="${icon}" class="icon-btn text-3xl p-2 rounded-lg hover:bg-primary/50 control-btn">${icon}</button>`).join('');
        iconGrid.querySelectorAll('.icon-btn').forEach(btn => btn.onclick = () => { emojiInput.value = btn.textContent; updateIconSelection(); });
    };
    const updateIconSelection = () => { if(emojiInput.value) { habitIconInput.value = openIconModalBtn.textContent = emojiInput.value; } };
    
    const populateWeekdays = () => {
        customWeekdaysContainer.innerHTML = WEEKDAYS_SHORT.map((day, i) => `<button type="button" data-day="${i}" class="weekday-btn control-btn w-9 h-9 flex items-center justify-center rounded-full bg-slate-900/70">${day}</button>`).join('');
        customWeekdaysContainer.querySelectorAll('.weekday-btn').forEach(btn => btn.onclick = () => {
            const isSelected = btn.dataset.selected === 'true';
            btn.dataset.selected = !isSelected;
            btn.classList.toggle('active-btn', !isSelected);
        });
    };
    const selectFrequency = (freq, weekdays = []) => {
        document.getElementById('habitFrequency').value = freq;
        freqButtons.forEach(btn => btn.classList.toggle('active-btn', btn.dataset.freq === freq));
        const isSingle = freq === 'none';
        customWeekdaysContainer.classList.toggle('hidden', freq !== 'custom');
        eventDateFieldWrapper.classList.toggle('hidden', !isSingle);
        scheduleOptionalText.classList.toggle('hidden', isSingle);
        eventDateInput.required = isSingle;
        dateRequiredIndicator.classList.toggle('hidden', !isSingle);
        if (freq === 'custom') {
            customWeekdaysContainer.querySelectorAll('.weekday-btn').forEach((btn, i) => {
                const isActive = weekdays.includes(i);
                btn.classList.toggle('active-btn', isActive);
                btn.dataset.selected = isActive;
            });
        }
    };
    const selectHabitType = (type) => {
        document.getElementById('habitType').value = type;
        goalOptionsContainer.classList.toggle('hidden', type === 'yes_no');
        measurableOptions.classList.toggle('hidden', type !== 'measurable');
        timedOptions.classList.toggle('hidden', type !== 'timed');
        habitTypeButtons.forEach(btn => btn.classList.toggle('active-btn', btn.dataset.type === type));
    };
    
    // --- Detail View Logic ---
    const openDetailView = (habit) => {
        activeDetailHabit = habit;
        updateDetailViewUI();
        habitDetailView.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-color');
        habitDetailView.style.transform = 'translateX(0)';
        appContainer.classList.add('modal-open');
    };
    const closeDetailView = () => {
        if (isTimerRunning) pauseTimer(true);
        habitDetailView.style.transform = 'translateX(100%)';
        if (!document.querySelector('.modal-container:not(.hidden)')) appContainer.classList.remove('modal-open');
        activeDetailHabit = null;
    };
    const updateDetailViewUI = () => {
        if (!activeDetailHabit) return;
        const version = getHabitVersionForDate(activeDetailHabit, selectedDate);
        detailIcon.textContent = version.icon || 'üéØ';
        detailHabitName.textContent = version.name;
        detailLogTodayContainer.innerHTML = getDetailLogHTML();
        calendarContainer.innerHTML = getDetailCalendarHTML();
        statsContainer.innerHTML = getDetailStatsHTML();
        statsContainer.style.display = version.frequency === 'none' ? 'none' : 'block';
        
        setupNotesSection();
        setupDetailViewListeners();
        updateDetailProgressCircle();
    };

    const setupNotesSection = () => {
        const dateStr = toISODateString(selectedDate);
        const version = getHabitVersionForDate(activeDetailHabit, selectedDate);
        
        notesSectionContainer.innerHTML = `
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-lg">Nota</h3>
                <div id="noteScopeContainer" class="flex items-center gap-2">
                    <button id="noteScopeDay" data-scope="day" class="note-scope-btn">Dia</button>
                    <button id="noteScopeGeneral" data-scope="general" class="note-scope-btn">Geral</button>
                </div>
            </div>
            <div id="notesEditor" class="relative">
                <textarea id="habitNoteTextarea" class="w-full bg-slate-800/60 p-3 rounded-lg text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus-ring-primary hidden" rows="4"></textarea>
                <div id="notePreview" class="notes-content cursor-pointer"></div>
            </div>`;

        const dailyNote = activeDetailHabit.history?.[dateStr]?.note || '';
        const generalNote = version.generalNote || '';

        // Precedence: if a daily note exists, default to it. Otherwise, default to general.
        currentNoteScope = dailyNote ? 'day' : 'general';

        const textarea = document.getElementById('habitNoteTextarea');
        const preview = document.getElementById('notePreview');
        const dayBtn = document.getElementById('noteScopeDay');
        const generalBtn = document.getElementById('noteScopeGeneral');

        const updateNoteView = (scope) => {
            currentNoteScope = scope;
            dayBtn.classList.toggle('active', scope === 'day');
            generalBtn.classList.toggle('active', scope === 'general');
            
            const text = scope === 'day' ? dailyNote : generalNote;
            const placeholder = scope === 'day' 
                ? 'Adicione uma nota para este dia...' 
                : 'Adicione uma nota geral para o h√°bito...';
            
            textarea.value = text;
            textarea.placeholder = placeholder;
            preview.innerHTML = marked.parse(text || `<span class="text-slate-500">Clique para adicionar uma nota ${scope === 'day' ? 'para o dia' : 'geral'}.</span>`);
        };
        
        dayBtn.onclick = () => updateNoteView('day');
        generalBtn.onclick = () => updateNoteView('general');

        const showEditor = () => { textarea.classList.remove('hidden'); preview.classList.add('hidden'); textarea.focus(); };
        const showPreview = () => { textarea.classList.add('hidden'); preview.classList.remove('hidden'); };
        
        preview.addEventListener('click', showEditor);
        textarea.addEventListener('blur', () => {
            showPreview();
            handleNoteSave();
        });
        textarea.addEventListener('input', () => {
            const noteValue = textarea.value;
            preview.innerHTML = marked.parse(noteValue);
        });

        updateNoteView(currentNoteScope);
    };

    const handleNoteSave = () => {
        const noteValue = document.getElementById('habitNoteTextarea').value;
        const habitIndex = habits.findIndex(h => h.id === activeDetailHabit.id);
        if (habitIndex === -1) return;
        
        if (currentNoteScope === 'day') {
            const dateStr = toISODateString(selectedDate);
            if (!habits[habitIndex].history) habits[habitIndex].history = {};
            if (!habits[habitIndex].history[dateStr]) habits[habitIndex].history[dateStr] = { value: 0, completed: false };
            habits[habitIndex].history[dateStr].note = noteValue;
            activeDetailHabit.history = habits[habitIndex].history;
        } else { // general note
            const effectiveDate = toISODateString(selectedDate);
            const rawHabit = habits[habitIndex];
            const previousVersion = getHabitVersionForDate(rawHabit, selectedDate);
            
            // If the general note is unchanged, do nothing.
            if(previousVersion.generalNote === noteValue) return;

            let versionForToday = rawHabit.versions.find(v => v.effectiveDate === effectiveDate);

            if (versionForToday) {
                versionForToday.generalNote = noteValue;
            } else {
                const newVersion = { ...previousVersion, generalNote: noteValue, effectiveDate };
                rawHabit.versions.push(newVersion);
                rawHabit.versions.sort((a,b) => a.effectiveDate.localeCompare(b.effectiveDate));
            }
            activeDetailHabit.versions = rawHabit.versions;
        }
        
        saveHabits();
    };

    const setupDetailViewListeners = () => {
        document.getElementById('detailToggleBtn')?.addEventListener('click', () => {
            const currentProgress = getHabitProgress(activeDetailHabit, toISODateString(selectedDate));
            updateHabitProgress(activeDetailHabit.id, toISODateString(selectedDate), 0, !currentProgress.completed, true);
        });

        const version = getHabitVersionForDate(activeDetailHabit, selectedDate);
        if (version.type === 'measurable') {
            const textContainer = document.getElementById('detailProgressText');
            textContainer.addEventListener('click', makeMeasurableEditable);
        }

        if (version.type === 'timed') {
            updateTimerDisplayState();
            document.getElementById('startPauseTimerBtn').onclick = () => isTimerRunning ? pauseTimer(true) : startTimer();
            document.getElementById('resetProgressBtn').onclick = resetTimedProgress;
            document.getElementById('completeTimedHabitBtn')?.addEventListener('click', completeTimedHabit);
            document.querySelectorAll('.quick-add-btn').forEach(btn => btn.onclick = () => addTimeToHabit(parseInt(btn.dataset.minutes)));
        }
    };
    
    function makeMeasurableEditable() {
        const textContainer = document.getElementById('detailProgressText');
        if (!textContainer || !activeDetailHabit || textContainer.querySelector('input')) return;

        const currentProgress = getHabitProgress(activeDetailHabit, toISODateString(selectedDate));
        textContainer.innerHTML = `<input type="number" id="detailMeasureInput" inputmode="decimal" class="w-3/4 bg-transparent text-white text-4xl font-bold text-center outline-none" value="${currentProgress.value}">`;
        
        const input = document.getElementById('detailMeasureInput');
        input.focus();
        input.select();

        const saveValue = () => {
            const newValue = parseFloat(input.value) || 0;
            updateHabitProgress(activeDetailHabit.id, toISODateString(selectedDate), newValue, null, true);
        };
        
        input.addEventListener('blur', saveValue);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') input.blur();
        });
    }

    function createDetailProgressCircleHTML(progress, version) {
        const isCompleted = progress.percentage >= 100;
        const r = 60, c = 2 * Math.PI * r, offset = c;
        let innerTextHTML = '';
        switch (version.type) {
            case 'yes_no': innerTextHTML = isCompleted ? `<i class="fas fa-check text-6xl"></i>` : `<i class="fas fa-times text-6xl text-slate-500"></i>`; break;
            case 'measurable': innerTextHTML = `<span class="text-4xl font-bold">${progress.value}</span><span class="text-slate-400 mt-1">/ ${version.goal} ${version.unit || ''}</span>`; break;
            case 'timed': const goal = version.timeUnit === 'hours' ? version.timeGoal * 60 : version.timeGoal; innerTextHTML = `<span class="text-4xl font-bold tracking-wider">${formatTime((progress.value || 0) * 60)}</span><span class="text-slate-400 text-sm mt-1">/ ${goal} min</span>`; break;
        }
        return `<div class="relative w-48 h-48 mx-auto mb-6">
            <svg class="w-full h-full" viewBox="0 0 132 132">
                <circle class="stroke-current text-gray-700/50" cx="66" cy="66" r="${r}" fill="none" stroke-width="12"></circle>
                <circle id="detailProgressCircle" class="progress-ring-circle detail-progress-circle ${isCompleted ? 'completed' : 'in-progress'}" cx="66" cy="66" r="${r}" fill="none" stroke-width="12" stroke-linecap="round" style="stroke-dasharray: ${c}; stroke-dashoffset: ${offset};"></circle>
            </svg>
            <div id="detailProgressText" class="absolute inset-0 flex flex-col items-center justify-center text-center cursor-pointer">${innerTextHTML}</div>
        </div>`;
    }

    function updateDetailProgressCircle() {
        const circle = document.getElementById('detailProgressCircle');
        if (!circle || !activeDetailHabit) return;
        const progress = getHabitProgress(activeDetailHabit, toISODateString(selectedDate));
        const r = circle.r.baseVal.value, c = 2 * Math.PI * r;
        const offset = c - (progress.percentage / 100) * c;
        setTimeout(() => { circle.style.strokeDashoffset = offset; }, 50);
        circle.classList.toggle('completed', progress.percentage >= 100);
        circle.classList.toggle('in-progress', progress.percentage < 100);
    }

    function getDetailLogHTML() {
        const dateStr = toISODateString(selectedDate);
        const version = getHabitVersionForDate(activeDetailHabit, selectedDate);
        const progress = getHabitProgress(activeDetailHabit, dateStr);
        const dateText = selectedDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });
        let controlsHTML = '';
        switch (version.type) {
            case 'yes_no': controlsHTML = `<button id="detailToggleBtn" class="w-full ${progress.completed ? 'bg-slate-600 hover:bg-slate-700' : 'bg-primary'} text-white font-bold py-3 rounded-xl text-lg control-btn active:scale-95">${progress.completed ? 'Desmarcar' : 'Concluir'}</button>`; break;
            case 'measurable': controlsHTML = `<p class="text-center text-slate-400 text-sm">Toque no valor acima para editar.</p>`; break;
            case 'timed':
                const isGoalReached = progress.percentage >= 100;
                const quickAdd = [1, 5, 10, 15, 30].map(min => `<button data-minutes="${min}" class="quick-add-btn flex-1 bg-primary/20 p-3 rounded-lg control-btn text-sm">+${min} min</button>`).join('');
                controlsHTML = `<div class="flex items-center justify-center space-x-4 mb-4"><button id="startPauseTimerBtn" class="w-36 bg-primary text-white font-bold py-3 rounded-xl text-lg control-btn active:scale-95 flex items-center justify-center gap-2"></button><button id="resetProgressBtn" class="w-16 h-12 rounded-xl bg-slate-600 control-btn active:scale-95 flex items-center justify-center text-lg"><i class="fas fa-undo"></i></button></div>
                ${!isGoalReached ? `<p class="text-xs text-center mb-2 text-slate-400">Ajuste r√°pido:</p><div class="flex gap-2 justify-center h-12">${quickAdd}<button id="completeTimedHabitBtn" title="Completar Meta" class="h-full flex items-center justify-center bg-green-500/80 hover:bg-green-500 rounded-lg control-btn text-white px-4"><i class="fas fa-check"></i></button></div>` : ''}`;
                break;
        }
        return `<h3 class="font-bold text-lg mb-2">Progresso em <span class="text-primary-light">${dateText}</span></h3>${createDetailProgressCircleHTML(progress, version)}<div>${controlsHTML}</div>`;
    }

    function getDetailCalendarHTML() {
        const viewDate = new Date(selectedDate);
        const year = viewDate.getFullYear(), month = viewDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        let daysHTML = Array(firstDay).fill('<div></div>').join('');
        for(let day=1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            if (!isHabitActiveOnDate(activeDetailHabit, date)) { daysHTML += `<div class="opacity-30">${day}</div>`; continue; }
            const completed = getHabitProgress(activeDetailHabit, toISODateString(date)).completed;
            const isSelected = toISODateString(date) === toISODateString(selectedDate);
            daysHTML += `<div class="calendar-day w-9 h-9 flex items-center justify-center rounded-full text-sm ${completed ? 'completed' : ''} ${isSelected ? 'ring-2 ring-primary' : ''} ${!completed ? 'border border-slate-700' : ''}">${day}</div>`;
        }
        return `<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Calend√°rio</h3><div class="text-lg font-semibold">${viewDate.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}</div></div><div class="grid grid-cols-7 gap-1 text-center mb-2">${WEEKDAYS_SHORT.map(d => `<div class="calendar-day-header">${d}</div>`).join('')}</div><div class="grid grid-cols-7 gap-y-2 text-center items-center">${daysHTML}</div>`;
    }

    function getDetailStatsHTML() {
        const version = getHabitVersionForDate(activeDetailHabit, selectedDate);
        if (!activeDetailHabit || version.frequency === 'none') return '';
        const stats = calculateStreakAndTotal(activeDetailHabit);
        return `<h3 class="font-bold text-lg mb-4">Estat√≠sticas do H√°bito</h3>
            <div class="grid grid-cols-3 gap-x-4 gap-y-6 text-center">
                <div><p class="text-3xl font-bold">üî• ${stats.currentStreak}</p><p class="text-sm text-primary-light">Sequ√™ncia Atual</p></div>
                <div><p class="text-3xl font-bold">üèÜ ${stats.maxStreak}</p><p class="text-sm text-primary-light">Melhor Sequ√™ncia</p></div>
                <div><p class="text-3xl font-bold">‚úÖ ${stats.totalCompleted}</p><p class="text-sm text-primary-light">Total Conclu√≠do</p></div>
            </div>`;
    }

    function calculateStreakAndTotal(habit) {
        const history = habit.history || {};
        const completedDates = Object.keys(history)
            .filter(dateStr => {
                const date = new Date(dateStr + 'T12:00:00');
                return history[dateStr].completed && isHabitActiveOnDate(habit, date);
            })
            .map(date => new Date(date + 'T00:00:00')) // Avoid timezone issues
            .sort((a, b) => b - a);

        let currentStreak = 0, maxStreak = 0;
        
        if (completedDates.length > 0) {
            let tempStreak = 1;
            maxStreak = 1;

            for (let i = 0; i < completedDates.length - 1; i++) {
                const currentDate = completedDates[i];
                let expectedPrevDate = new Date(currentDate);
                let diff = 0;

                // Find the actual previous active day
                let foundPrevActiveDay = false;
                for (let d = 1; d < 8; d++) { // Check up to a week back
                    expectedPrevDate.setDate(currentDate.getDate() - d);
                    if (isHabitActiveOnDate(habit, expectedPrevDate)) {
                        diff = (currentDate - completedDates[i+1]) / (1000 * 60 * 60 * 24);
                        if (diff === d) {
                           foundPrevActiveDay = true;
                        }
                        break;
                    }
                }
                
                if (foundPrevActiveDay) {
                    tempStreak++;
                } else {
                    maxStreak = Math.max(maxStreak, tempStreak);
                    tempStreak = 1;
                }
            }
            maxStreak = Math.max(maxStreak, tempStreak);
            
            const today = new Date(new Date().toDateString());
            let latestCompletion = completedDates[0];
            
            let isTodayOrYesterdayActive = false;
            if (isHabitActiveOnDate(habit, today) && latestCompletion.getTime() === today.getTime()){
                 isTodayOrYesterdayActive = true;
            } else {
                 let yesterday = new Date(today);
                 yesterday.setDate(today.getDate() - 1);
                 while(!isHabitActiveOnDate(habit, yesterday)){
                     yesterday.setDate(yesterday.getDate() - 1);
                 }
                 if(latestCompletion.getTime() === yesterday.getTime()){
                     isTodayOrYesterdayActive = true;
                 }
            }

            if (isTodayOrYesterdayActive) {
                currentStreak = maxStreak;
            }
        }
        return { currentStreak, maxStreak, totalCompleted: completedDates.length };
    }


    // --- Timer Functions ---
    const updateTimerDisplayState = () => {
        if (!activeDetailHabit) return;
        const version = getHabitVersionForDate(activeDetailHabit, selectedDate);
        if (version.type !== 'timed') return;

        const btn = document.getElementById('startPauseTimerBtn');
        if (!btn) return;
        
        const goal = version.timeUnit === 'hours' ? version.timeGoal * 60 : version.timeGoal;
        const isGoalReached = (getHabitProgress(activeDetailHabit, toISODateString(selectedDate)).value || 0) >= goal;
        
        btn.disabled = isGoalReached;
        if (isGoalReached) { btn.innerHTML = '<i class="fas fa-check mr-2"></i>Conclu√≠do'; if(isTimerRunning) pauseTimer(true); } 
        else { btn.innerHTML = isTimerRunning ? '<i class="fas fa-pause mr-2"></i> Pausar' : '<i class="fas fa-play mr-2"></i> Iniciar'; }
    };
    const startTimer = () => {
        if (isTimerRunning || !activeDetailHabit) return;
        isTimerRunning = true; sessionStartTime = Date.now();
        updateTimerDisplayState();
        timerInterval = setInterval(() => {
            const elapsed = (Date.now() - sessionStartTime) / 1000;
            const dateStr = toISODateString(selectedDate);
            const habit = habits.find(h=>h.id===activeDetailHabit.id);
            if (!habit) { pauseTimer(false); return; }
            const initialMinutes = habit.history[dateStr]?.value || 0;
            updateHabitProgress(activeDetailHabit.id, dateStr, initialMinutes + elapsed / 60, null, false);
        }, 1000);
    };
    const pauseTimer = (shouldSave) => {
        if (!isTimerRunning) return;
        const elapsed = (Date.now() - sessionStartTime) / 1000;
        isTimerRunning = false; clearInterval(timerInterval); timerInterval = null;
        if(shouldSave) {
            const dateStr = toISODateString(selectedDate);
            const habit = habits.find(h=>h.id===activeDetailHabit.id);
            if (!habit) return;
            const initialMinutes = habit.history[dateStr]?.value || 0;
            updateHabitProgress(activeDetailHabit.id, dateStr, initialMinutes + elapsed / 60, null, true);
        }
        updateTimerDisplayState();
    };
    const resetTimedProgress = () => { if (isTimerRunning) pauseTimer(false); updateHabitProgress(activeDetailHabit.id, toISODateString(selectedDate), 0, false, true); };
    const addTimeToHabit = (minutes) => {
        const current = getHabitProgress(activeDetailHabit, toISODateString(selectedDate)).value || 0;
        updateHabitProgress(activeDetailHabit.id, toISODateString(selectedDate), current + minutes, null, true);
    };
    const completeTimedHabit = () => {
        if (isTimerRunning) pauseTimer(false);
        const version = getHabitVersionForDate(activeDetailHabit, selectedDate);
        const goal = version.timeUnit === 'hours' ? version.timeGoal * 60 : version.timeGoal;
        updateHabitProgress(activeDetailHabit.id, toISODateString(selectedDate), goal, true, true);
    };

    // --- Data Persistence ---
    const saveHabits = (shouldRender = true) => {
        localStorage.setItem(DB_KEY, JSON.stringify(habits));
        if (shouldRender) renderViewForDate(selectedDate);
        if (activeDetailHabit) {
            const updated = habits.find(h => h.id === activeDetailHabit.id);
            if(updated) { activeDetailHabit = updated; updateDetailViewUI(); } 
            else { closeDetailView(); }
        }
    };
    const updateHabitProgress = (id, dateStr, value, completed, shouldSave) => {
        const idx = habits.findIndex(h => h.id === id);
        if (idx === -1) return;
        const habit = habits[idx];
        if (!habit.history) habit.history = {};
        const entry = habit.history[dateStr] || { value: 0, completed: false, note: '' };
        
        let isCompleted = completed;
        if (isCompleted === null) {
            const version = getHabitVersionForDate(habit, new Date(dateStr + 'T12:00:00'));
            const goal = version.goal || 1;
            const timeGoal = version.timeUnit === 'hours' ? version.timeGoal * 60 : version.timeGoal;
            if (version.type === 'measurable') isCompleted = value >= goal;
            else if (version.type === 'timed') isCompleted = value >= timeGoal;
            else isCompleted = entry.completed;
        }
        
        habit.history[dateStr] = { ...entry, value, completed: isCompleted };

        if (activeDetailHabit?.id === id) activeDetailHabit = { ...habit };
        if (shouldSave) saveHabits();
        else { 
            if (activeDetailHabit?.id === id) updateDetailViewUI(); 
            updateListItemUI(id, dateStr); 
            updateOverallProgress(habits.filter(h => isHabitActiveOnDate(h, selectedDate)), selectedDate);
        }
    };
    const updateListItemUI = (id, dateStr) => {
        const item = habitListContainer.querySelector(`.habit-item[data-id="${id}"]`);
        if (!item) return;
        const habitToUpdate = habits.find(h=>h.id===id);
        if(!habitToUpdate) return;
        
        const newHTML = createHabitItemHTML(habitToUpdate, dateStr);
        item.outerHTML = newHTML;
        
        const newItem = habitListContainer.querySelector(`.habit-item[data-id="${id}"]`);
        if (newItem) {
            newItem.addEventListener('click', () => openDetailView(habits.find(h=>h.id===id)));
            triggerCircleAnimations(newItem);
        }
    };

    // --- Settings & Theme ---
    const applyThemeColor = (color) => {
        const root = document.documentElement.style;
        const hsl = hexToHsl(color);
        if (!hsl) return;
        
        const darkBgColor = `hsl(${hsl.h}, 30%, 8%)`;
        root.setProperty('--bg-color', darkBgColor);
        root.setProperty('--primary-color', color);
        const rgb = hexToRgb(color);
        root.setProperty('--primary-color-dark', `rgb(${Math.round(rgb.r*0.9)}, ${Math.round(rgb.g*0.9)}, ${Math.round(rgb.b*0.9)})`);
        root.setProperty('--primary-color-light', color);
        root.setProperty('--primary-color-hover-bg', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15)`);
        
        document.querySelector('meta[name="theme-color"]').setAttribute('content', darkBgColor);
        document.querySelectorAll('.color-swatch').forEach(sw => sw.classList.toggle('active', sw.dataset.color === color));
    };
    const saveAndApplyThemeColor = (color) => { localStorage.setItem('appThemeColor', color); applyThemeColor(color); };
    
    function calculateOverallStats() {
        // This function would need significant rework to be meaningful with versioned habits.
        // For now, it provides a simple count based on current definitions.
        let totalCompletions = 0;
        let activeDays = new Set();
        
        habits.forEach(habit => {
             Object.entries(habit.history || {}).forEach(([dateStr, entry]) => {
                if (entry.completed) {
                    totalCompletions++;
                    activeDays.add(dateStr);
                }
            });
        });
        
        overallStatsContainer.innerHTML = `
            <h3 class="font-bold text-lg mb-4 text-center text-primary-light">Estat√≠sticas Gerais (Simplificado)</h3>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div><p class="text-3xl font-bold">üéØ ${totalCompletions}</p><p class="text-sm text-slate-400">Total de Conclus√µes</p></div>
                <div><p class="text-3xl font-bold">üóìÔ∏è ${activeDays.size}</p><p class="text-sm text-slate-400">Dias Ativos</p></div>
            </div>`;
    }

    // --- Data Import/Export ---
    const exportData = () => {
        const data = { habits: habits, settings: { themeColor: localStorage.getItem('appThemeColor') || THEME_COLORS.default } };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
        a.download = `habitx_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
    };
    const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if (!Array.isArray(data.habits)) throw new Error('Formato de arquivo inv√°lido.');
                habits = data.habits;
                if (data.settings?.themeColor) saveAndApplyThemeColor(data.settings.themeColor);
                init(true); // Re-initialize with imported data
                closeModal(settingsModal);
            } catch (err) { alert(`Erro ao importar: ${err.message}`); } finally { importFileInput.value = ''; }
        };
        reader.readAsText(file);
    };

    // --- Real-Time Update ---
    const checkRealTimeUpdates = () => {
        const isToday = toISODateString(selectedDate) === toISODateString(new Date());
        const isModalOpen = document.querySelector('.modal-container:not(.hidden)') || habitDetailView.style.transform === 'translateX(0px)';
        if (!isToday || isModalOpen) return;
        renderHabits(selectedDate);
    };

    // --- Event Listeners ---
    addHabitBtn.addEventListener('click', () => openEditModal());
    cancelBtn.addEventListener('click', () => closeModal(habitModal));
    returnToTodayBtn.addEventListener('click', () => {
        const today = new Date(toISODateString(new Date()));
        const current = new Date(toISODateString(selectedDate));
        const diffDays = Math.round((today - current) / (1000 * 60 * 60 * 24));
        if (diffDays !== 0) changeDate(diffDays);
    });
    openIconModalBtn.addEventListener('click', () => { emojiInput.value = habitIconInput.value; openModal(iconModal); });
    emojiInput.addEventListener('input', updateIconSelection);
    confirmIconBtn.addEventListener('click', () => { updateIconSelection(); closeModal(iconModal); });
    closeDetailViewBtn.addEventListener('click', closeDetailView);
    editHabitFromDetailBtn.addEventListener('click', () => { if(activeDetailHabit) { const habit = JSON.parse(JSON.stringify(activeDetailHabit)); closeDetailView(); setTimeout(() => openEditModal(habit), 300); } });
    habitTypeButtons.forEach(b => b.addEventListener('click', () => selectHabitType(b.dataset.type)));
    freqButtons.forEach(b => b.addEventListener('click', () => selectFrequency(b.dataset.freq)));
    [startTimeInput, endTimeInput].forEach(el => el.addEventListener('input', () => {
        endTimeInput.setCustomValidity(endTimeInput.value && startTimeInput.value && endTimeInput.value < startTimeInput.value ? 'Fim n√£o pode ser antes do in√≠cio.' : '');
    }));
    
    habitForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!habitForm.checkValidity()) { habitForm.reportValidity(); return; }
        
        const frequency = document.getElementById('habitFrequency').value;
        const eventDateValue = document.getElementById('eventDate').value;
        const effectiveDate = frequency === 'none' ? eventDateValue : toISODateString(selectedDate);

        const newVersionData = {
            name: document.getElementById('habitName').value.trim(),
            icon: habitIconInput.value,
            frequency,
            weekdays: Array.from(customWeekdaysContainer.querySelectorAll('.weekday-btn[data-selected="true"]')).map(b => parseInt(b.dataset.day)),
            type: document.getElementById('habitType').value,
            goal: parseFloat(document.getElementById('habitGoal').value) || 1,
            unit: document.getElementById('habitUnit').value.trim() || '',
            timeGoal: parseFloat(document.getElementById('habitTimeGoal').value) || 60,
            timeUnit: document.getElementById('habitTimeUnit').value,
            date: eventDateValue || null,
            startTime: startTimeInput.value || null,
            endTime: endTimeInput.value || null,
            generalNote: document.getElementById('habitGeneralNote').value.trim() || '',
            effectiveDate,
        };
        
        if (currentEditId) {
            const habitIndex = habits.findIndex(h => h.id === currentEditId);
            const rawHabit = habits[habitIndex];
            const previousVersion = getHabitVersionForDate(rawHabit, selectedDate);
            
            let versionForToday = rawHabit.versions.find(v => v.effectiveDate === effectiveDate);
            if (versionForToday) {
                // Update existing version for this day
                Object.assign(versionForToday, newVersionData);
            } else {
                // Create a new version
                const newVersion = { ...previousVersion, ...newVersionData, effectiveDate };
                rawHabit.versions.push(newVersion);
                rawHabit.versions.sort((a,b) => a.effectiveDate.localeCompare(b.effectiveDate));
            }
        } else {
            habits.push({
                id: Date.now(),
                history: {},
                versions: [newVersionData]
            });
        }

        saveHabits();
        closeModal(habitModal);
    });

    deleteBtn.addEventListener('click', () => {
        if (currentEditId) {
            const detailOpen = activeDetailHabit?.id === currentEditId;
            habits = habits.filter(h => h.id !== currentEditId);
            saveHabits();
            closeModal(habitModal);
            if (detailOpen) closeDetailView();
        }
    });
    settingsBtn.addEventListener('click', () => { calculateOverallStats(); openModal(settingsModal); });
    closeSettingsBtn.addEventListener('click', () => closeModal(settingsModal));
    exportDataBtn.addEventListener('click', exportData);
    importDataBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', importData);
    resetColorBtn.addEventListener('click', () => saveAndApplyThemeColor(THEME_COLORS.default));

    // --- Initial Load ---
    const init = (isImport = false) => {
        // Migration from old data structure
        let migrated = false;
        habits.forEach(habit => {
            if (!habit.versions) {
                migrated = true;
                const { id, history, ...props } = habit;
                habit.versions = [{
                    effectiveDate: '2000-01-01', // Represents the beginning of time for this habit
                    name: props.name || 'H√°bito sem nome', icon: props.icon || 'üéØ',
                    frequency: props.frequency || 'daily', weekdays: props.weekdays || [],
                    type: props.type || 'yes_no', goal: props.goal || 1, unit: props.unit || '',
                    timeGoal: props.timeGoal || 60, timeUnit: props.timeUnit || 'minutes',
                    date: props.date || null, startTime: props.startTime || null, endTime: props.endTime || null,
                    generalNote: props.generalNote || ''
                }];
                Object.keys(props).forEach(key => delete habit[key]);
            }
        });

        if (migrated && !isImport) {
            console.log("H√°bitos migrados para a nova estrutura com versionamento.");
            saveHabits(false);
        }

        const savedColor = localStorage.getItem('appThemeColor') || THEME_COLORS.default;
        let colorHTML = Object.values(THEME_COLORS).map(c => `<div class="color-swatch" data-color="${c}" style="background-color: ${c};"></div>`).join('');
        colorHTML += `<div><input type="color" id="colorPickerInput" value="${savedColor}"></div>`;
        colorSwatchesContainer.innerHTML = colorHTML;

        document.querySelectorAll('.color-swatch').forEach(sw => sw.addEventListener('click', () => saveAndApplyThemeColor(sw.dataset.color)));
        document.getElementById('colorPickerInput').addEventListener('input', (e) => saveAndApplyThemeColor(e.target.value));

        applyThemeColor(savedColor);
        marked.setOptions({ gfm: true, breaks: true, sanitize: true });
        populateIconGrid();
        populateWeekdays();
        selectFrequency('daily');
        selectHabitType('yes_no');
        renderViewForDate(selectedDate);
        if(realTimeUpdateInterval) clearInterval(realTimeUpdateInterval);
        realTimeUpdateInterval = setInterval(checkRealTimeUpdates, 60000);
    };
    init();
});
</script>

</body>
</html>